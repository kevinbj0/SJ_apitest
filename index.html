<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce LWC Loader</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        #agentforceChatbotDivId {
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        #errorMessage {
            color: red;
            background-color: #ffebee;
            padding: 1rem;
            border-radius: 8px;
            max-width: 600px;
        }
    </style>
</head>
<body>
    <!-- ì±—ë´‡ì´ ë Œë”ë§ë  ì»¨í…Œì´ë„ˆ -->
    <div id="agentforceChatbotDivId"></div>
    <!-- ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  ì»¨í…Œì´ë„ˆ -->
    <div id="errorMessage" style="display:none;"></div>

    <script src="https://connect-flow-8014--ps.sandbox.lightning.force.com/lightning/lightning.out.js"></script>
    <script>
        // ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„: Vercel URL ëŒ€ì‹  ìƒˆë¡œìš´ Heroku ì•± URLë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        const myApiUrl = 'https://pyheroku-d21d18e4f257.herokuapp.com/api/getToken';

        const salesforceUrl = 'https://connect-flow-8014--ps.sandbox.lightning.force.com/';
        const appName = 'c:zzChatBot_Aura';
        const componentName = 'c:sj_Chatbot';

        const lwcAttributes = {
            isDarkMode: false,
            chatbot_width: '350px',
            chatbot_height: '600px'
        };

        // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function displayError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

   
        // APIë¥¼ í˜¸ì¶œí•˜ì—¬ í† í°ì„ ê°€ì ¸ì˜¤ê³  LWCë¥¼ ë¡œë“œí•˜ëŠ” ë¡œì§
        async function getToken(){
            fetch(myApiUrl, { method: 'POST' }) // í”„ë¡ì‹œ ì„œë²„ì— POST ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(`ë°±ì—”ë“œ API ì—ëŸ¬ (Status: ${response.status}): ${JSON.stringify(errorData)}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    let accessToken = data.access_token;
                    if (!accessToken) {
                        throw new Error("ì‘ë‹µ ë°ì´í„°ì— access_tokenì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                
                    console.log("Heroku í”„ë¡ì‹œë¥¼ í†µí•´ ì•ˆì „í•˜ê²Œ í† í°ì„ ë°›ì•˜ìŠµë‹ˆë‹¤4:", accessToken);
                })
                .catch(error => {
                    console.error('ì „ì²´ í”„ë¡œì„¸ìŠ¤ í˜¸ì¶œ ì‹¤íŒ¨3:', error);
                    displayError(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                });

            const salesforceApiUrl = 'https://connect-flow-8014--ps.sandbox.my.salesforce.com/services/apexrest/summarizeChat/';
            const chatData = {
                chatlog: "ì•ˆë…•"      
            };
            console.log("í…ŒìŠ¤íŠ¸3");
            console.log(accessToken);

            return accessToken;
        }
        
        async function getChatSummary(){
            console.log("ì…ì¥");
            let accessToken = await getToken();

            <!-- setTimeout(() => {} , 5000); -->
            fetch(salesforceApiUrl, {
                method: 'POST',
                headers: {
                    // Bearer ë’¤ì— ê³µë°±ì´ ì¤‘ìš”í•©ë‹ˆë‹¤.
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                // JavaScript ê°ì²´ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                body: JSON.stringify(chatData)
            })
            .then(response => {
                if (!response.ok) {
                    // API í˜¸ì¶œì´ ì‹¤íŒ¨í•˜ë©´ ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.
                    throw new Error(`Salesforce API ì—ëŸ¬: ${response.status}`);
                }
                return response.json(); // ì‘ë‹µì„ JSON í˜•íƒœë¡œ íŒŒì‹±í•©ë‹ˆë‹¤.
            })
            .then(result => {
                // ì„±ê³µì ì¸ ì‘ë‹µì„ ì½˜ì†”ì— ì¶œë ¥í•©ë‹ˆë‹¤.
                console.log('Salesforce API ì‘ë‹µ:', result);
            })
            .catch(error => {
                // API í˜¸ì¶œ ì¤‘ ë°œìƒí•œ ì—ëŸ¬ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                console.error('Salesforce API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                displayError(`Salesforce API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            })
        }
        getChatSummary();
    </script>
</body>
</html>